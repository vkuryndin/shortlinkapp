name: Static Analysis

on:
  push:
    branches: [ main, master, develop, feature/** ]
    paths:
      - '**/*.java'
      - 'build.gradle'
      - 'build.gradle.kts'
      - 'settings.gradle'
      - 'settings.gradle.kts'
      - 'gradle.properties'
      - 'config/checkstyle/**'
      - '.github/workflows/static-analysis.yml'
  pull_request:
    paths:
      - '**/*.java'
      - 'build.gradle'
      - 'build.gradle.kts'
      - 'settings.gradle'
      - 'settings.gradle.kts'
      - 'gradle.properties'
      - 'config/checkstyle/**'
      - '.github/workflows/static-analysis.yml'

permissions:
  contents: read

concurrency:
  group: static-analysis-${{ github.ref }}
  cancel-in-progress: true

jobs:
  static-analysis:
    name: Spotless · Checkstyle · SpotBugs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Gradle (with caching)
        uses: gradle/actions/setup-gradle@v4

      - name: Make Gradle wrapper executable
        run: chmod +x gradlew

      # Run only static-analysis tasks (no compilation tests or packaging beyond what they need)
      - name: Run static checks (Spotless, Checkstyle, SpotBugs)
        run: |
          ./gradlew \
            spotlessCheck \
            checkstyleMain checkstyleTest \
            spotbugsMain spotbugsTest \
            --no-daemon --stacktrace

      # Always publish the HTML reports to help debugging even on failures
      - name: Upload Spotless diff (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotless-diff
          path: '**/.gradle/spotless/spotless*.diff'
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload Checkstyle reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-reports
          path: build/reports/checkstyle
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload SpotBugs reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-reports
          path: |
            build/reports/spotbugs/main.html
            build/reports/spotbugs/test.html
            build/reports/spotbugs/main.xml
            build/reports/spotbugs/test.xml
          if-no-files-found: ignore
          retention-days: 7

      # Optional: write a brief summary to the job summary page
      - name: Summary
        if: always()
        run: |
          echo "## Static Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Spotless: ran \`spotlessCheck\`" >> $GITHUB_STEP_SUMMARY
          echo "- Checkstyle: reports saved under \`build/reports/checkstyle\`" >> $GITHUB_STEP_SUMMARY
          echo "- SpotBugs: HTML/XML reports uploaded as artifacts" >> $GITHUB_STEP_SUMMARY
